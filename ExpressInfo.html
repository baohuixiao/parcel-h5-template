<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <title>收件信息</title>
  <script src="https://act.development.platform.babybus.com/lib/jquery/dist/jquery.min.js"></script>
  <script src="https://act.development.platform.babybus.com/lib/tool/vconsole.min.js"></script>
  <script>
    // 页面适配
    (function () {
      var html = document.documentElement;
      var windowWidth = html.clientWidth > 600 ? 600 : html.clientWidth;
      html.style.fontSize = windowWidth / 7.5 + 'px';
    }());

    var localGiftData = {
      "001": {
        name: 'JOJO的小火车',
        description: '职业拼图套装，开启职业认知',
        price: 58,
        icon: 'https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/299cd63075c045eaba7e2df6b695d00d.png',
        imgList: [
          'https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/3cf813d66dad4dceb09589feac9e93cf.png',
          'https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/273399a239d441b393d2e2566d4316f6.png',
          'https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/aa8226100974451992524e4360b43af9.png'
        ],
        iconBgColor: '#d3efff',
        iconBottomColor: '#95d8ff',
      },
      "002": {
        name: '恐龙积木',
        description: '学习恐龙百科，促进脑部开发',
        price: 49,
        icon: 'https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/5d9f7bb35ef7424e97ef749a2c5ad486.png',
        imgList: [
          'https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/2e2faa9c621847dd93a107c2a2c60ac8.png',
          'https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/97611bc7877a4a9a8168f33f4e36f082.png'
        ],
        iconBgColor: '#ffddde',
        iconBottomColor: '#ffc4ca',
      },
      "003": {
        name: '奇妙古诗词',
        description: '60首古诗词，国学经典启蒙',
        price: 49,
        icon: 'https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/34a130cf261e405fbff03c7e75b911eb.png',
        imgList: [
          'https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/0d0da0404d2b4d1099406663e8b2041c.png',
          'https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/1d31571c3ee741edb718d1c2a174ca05.png',
          'https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/aa46009d1a434e3d829fe2b25797b4c7.png'
        ],
        iconBgColor: '#efdef8',
        iconBottomColor: '#e1c4fa',
      },
    };

    var vConsole = new VConsole();
  </script>

  <link rel="stylesheet" type="text/css" href="./css/expressInfo.css" />

</head>

<body>
  <!-- 埋点 -->
  <div style="position: absolute;width:0;height:0;overflow:hidden;">
    <script type="text/javascript" src="https://s9.cnzz.com/z_stat.php?id=1279349239&web_id=1279349239"></script>
  </div>
  <div @touchmove.prevent class="shadow" onClick="closeSuccessPop()">
    <div class="pop-wrap">
      <img class="pop"
        src="https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/d36725f8be6f4f2681024f820a9a6f93.png" />
      <div class="pop-content">收件信息提交成功,赠送的<span id="giftName"></span>将在7个工作日内发出，请您耐心等待~</div>
    </div>
  </div>
  <div id="app" class="container" v-show="pageShow">
    <img v-if="hasGift" class="address-bg"
      src="https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/fb700fe73b0a40d1a763623eca39c18f.png" />
    <img class="gift-cover" v-if="hasGift" :src="giftCover" />
    <div class="gift-tip" v-if="hasGift">你有待领取的{{giftName}}</div>
    <img v-if="!hasGift" class="address-bg"
      src="https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210322/c83a15c9585a466589e4f6c17d6182c5.png" />
    <div v-if="!hasGift" class="gift-list" :class="{'space-around': giftList.length === 2}">
      <div class="gift-item"
        v-bind:class="{'gift-item-multiple': giftList.length > 2, 'active-item': index === giftSelectedIndex}"
        v-for="(giftItem, index) in giftList" @click="handleGiftClick(index)">
        <div class="title-wrap">{{giftItem.name}}</div>
        <img class="gift-icon" :src="giftItem.icon" />
        <img v-show="index !== giftSelectedIndex" class="check-icon"
          src="https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210319/6d8fcdb9e9954cfbafcadc4427b0f885.png" />
        <img v-show="index === giftSelectedIndex" class="check-icon"
          src="https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210319/5dbbafa922a44027a877da593e563980.png" />
      </div>
      <div class="gitf-item-padding" v-if="giftList.length > 2"></div>
    </div>
    <div class="content-wrap">
      <div class="content-item">
        收货人：<input class="input" id="name" placeholder="请输入2-10个中文汉字" maxlength="10" />
      </div>
      <div class="content-item">
        详细地址：
        <textarea id="textarea" class="textarea" maxlength="40" rows="3" cols="20"
          placeholder="请输入省、市、区及剩余详细地址(6-40字)"></textarea>
      </div>
      <div class="content-item">
        联系电话：<input class="input" id="phone" placeholder="重要！请填写11位正确手机号" tabindex="1" type='text' maxlength="11"
          autocomplete="off" />
      </div>
      <div class="tip-wrap">(宝宝巴士将在您提交收件信息后7个工作日内发出礼品)</div>
    </div>
    <img class="bottom-btn" id="submit"
      src="https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210319/e463ff34090a4da29b9dd4eb4f33a89e.png" />
  </div>

  <!-- 服务端vue -->
  <!-- <script src="https://actcdn.babybus.com/lib/vue/vue.min.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script>
    // 埋点
    var _czc = _czc || [];
    _czc.push(["_setAccount", "1279349239"]);

    var OrderNo = getQueryString('OrderNo');
    var aid = getQueryString('aid');
    var awardCode = getQueryString('awardCode');
    var packageID = getQueryString('packageID');

    if (document.documentElement.clientHeight < document.documentElement.clientWidth) {
      // document.querySelector(".pop-wrap").style.width = '50%';
      document.querySelector(".pop-wrap").style.transform = 'translate(-50%, -60%) scale(0.6)'
    }

    //获取页面传参
    function getQueryString(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
      var r = window.location.search.substr(1).match(reg);
      if (r != null) return decodeURI(r[2]);
      return null;
    }

    var app = new Vue({
      el: '#app',
      data: {
        pageShow: false,
        giftList: [],
        giftSelectedIndex: 0,
        hasGift: false,
        giftCover: '',
        giftName: '',
      },

      methods: {
        handleGiftClick: function (index) {
          if (this.giftSelectedIndex === index) return;
          this.giftSelectedIndex = index;
        },

        getAwardList: function () {
          return new Promise(function (resolve, reject) {
            $.ajax({
              url: '/AppActivity/MoreVIPPay_Index',
              data: {
                aid: aid,
              },
              method: 'GET',
              dataType: 'json',
              success: function (res) {
                resolve(res);
              },
              fail: function (err) {
                reject(err);
                console.log("首页数据获取失败");
              }
            })
          })
        },

        handleIndexData(packageList) {
          for (var i = 0; i < packageList.length; i += 1) {
            if (packageList[i].awardList && packageList[i].awardList.length > 0) {
              for (var j = 0; j < packageList[i].awardList.length; j += 1) {
                var tempObj = localGiftData.hasOwnProperty(packageList[i].awardList[j].awardCode) ?
                  localGiftData[packageList[i].awardList[j].awardCode] : null;
                if (tempObj) {
                  tempObj.num = packageList[i].awardList[j].num;
                  tempObj.awardCode = packageList[i].awardList[j].awardCode;
                  tempObj.awardID = packageList[i].awardList[j].awardID;
                }
                packageList[i].awardList[j] = tempObj;
              }
            }
          }
          return packageList;
        },

        findAwardList(list, packageID) {
          for (var i = 0; i < list.length; i += 1) {
            if (list[i].iPackageID === Number(packageID) || list[i].aPackageID === Number(packageID)) {
              if (list[i].awardList.length > 0) {
                var newList = list[i].awardList.filter(function (item) {
                  return item.num > 0;
                })
                return newList;
              }
            }
          }
        }
      },

      created: function () {
        if (awardCode === '0') {
          var that = this;
          console.log('需要选择礼物')
          this.getAwardList().then(function (res) {
            console.log(res);
            if (res.resultCode === "0") {
              var packageList = res.data.packageList;
              if (packageList.length > 0) {
                that.packageList = that.handleIndexData(packageList);
                that.giftList = that.findAwardList(that.packageList, packageID);
                console.log(that.findAwardList(that.packageList, packageID))
              }
            }
          });
        } else {
          this.hasGift = true;
          this.giftCover = localGiftData[awardCode].icon;
          this.giftName = localGiftData[awardCode].name;
        }
      },

      mounted: function () {
        this.pageShow = true;
      }
    })

    // toast组件封装
    var showToast = (function () {
      var div;
      var toastFlag = true;
      var timer = null;
      return function (text, time) {
        if (!text.trim() || !toastFlag) {
          return;
        }
        var duration = time ? time : 2000;
        toastFlag = false;
        timer = null;
        if (!div) {
          div = document.createElement("div");
          div.style.cssText =
            "position: fixed; display: none; font-size: 0.32rem; color: #fff; z-index: 5; max-width: 5rem; min-width: 4rem;text-align:center;top: 40%;padding: 0.1rem 0.3rem;border-radius: 0.5rem;background-color: rgba(0, 0, 0, 0.7);left:50%;transform: translateX(-50%);";
          document.body.appendChild(div);
        }
        div.innerText = text;
        div.style.display = 'block'
        timer = setTimeout(function () {
          toastFlag = true;
          clearTimeout(timer);
          div.style.display = 'none'
        }, duration)
      }
    }())

    //校验手机号
    function isPoneAvailable(phone) {
      var myreg = /^[1][3,4,5,6,7,8,9][0-9]{9}$/;
      if (!myreg.test(phone)) {
        return false;
      } else {
        return true;
      }
    }

    oBtn = document.getElementById('submit');

    // 防抖函数
    function debounce(fn, time, triggleNow) {
      var t = null;

      return function () {
        var _self = this
        args = arguments;

        if (t) {
          clearTimeout(t);
        }

        if (triggleNow) {
          var exce = !t;

          t = setTimeout(function () {
            t = null;
          }, time)

          if (exce) {
            fn.apply(_self, args);
          }
        } else {
          t = setTimeout(function () {
            fn.apply(_self, args);
            t = null;
          }, time)
        }
      }
    }

    oBtn.onclick = debounce(sendAddressText, 300, true)

    function sendAddressText() {
      checkData();
    }

    function checkData() {
      var phone = $("#phone").val();
      var name = $("#name").val();
      var address = $("#textarea").val();
      var tip = '请输入正确的信息';
      if (isPoneAvailable(phone) && address.length >= 6 && name.length >= 2) {
        if (navigator.onLine) {
          postData(phone, name, address)
        } else {
          showToast('网络未连接，请检查网络设置');
        }
      } else {
        if (name.length < 2) {
          tip = '请输入正确的收货人名称';
        } else if (address.length < 6) {
          tip = '请输入正确的地址';
        } else if (!isPoneAvailable(phone)) {
          tip = '请输入正确的手机号';
        }
        showToast(tip);
      }
    }

    function postData(phoneNumber, userName, address) {
      try {
        _czc.push(["_trackEvent", "提交收件信息", "点击"])
      } catch (error) {
        console.log(error)
      }
      $.ajax({
        url: '/AppActivity/MoreVIPPay_SetExpressInfo',
        data: {
          phone: phoneNumber,
          orderNo: OrderNo,
          userName: userName,
          address: address,
          aid: aid,
          awardCode: awardCode === '0' ? app.giftList[app.giftSelectedIndex].awardCode : null,
        },
        method: 'POST',
        dataType: 'json',
        complete: function (res) {
          console.log(res)
        },
        success: function (res) {
          console.log("发送成功")
          if (res.resultCode === "0") {
            _czc.push(["_trackEvent", "收件信息提交", "成功"])
            localStorage.setItem('toFresh', 'true');
            document.getElementById('giftName').innerText = app.giftName ? app.giftName : app.giftList[app.giftSelectedIndex].name;
            showSuccessPop();
          } else {
            _czc.push(["_trackEvent", "收件信息提交", "失败"])
            showToast(res.resultMessage);
          }
        },
        fail: function (err) {
          _czc.push(["_trackEvent", "收件信息提交失败", ""])
          showToast('发送失败,请稍后重试');
          console.log("发送失败")
        }
      })
    }

    function showSuccessPop() {
      $("html").add("body").css({
        "overflow": "hidden"
      })
      $('html').css('height', '100%')
      $('body').css('height', '100%')
      document.body.addEventListener('touchmove', handle, {
        passive: false
      })
      //显示领取成功弹窗
      document.querySelector(".shadow").style.display = 'block';
    }

    function closeSuccessPop() {
      $("html").add("body").css({
        "overflow": "auto"
      })
      $('html').css('height', 'auto')
      $('body').css('height', 'auto')
      document.body.removeEventListener('touchmove', handle, {
        passive: false
      })
      document.querySelector(".shadow").style.display = 'none';
      try {
        if (navigator.userAgent.toLowerCase().indexOf('android') >= 0) {
          window.AndroidService.closeBrowsers();
        } else {
          window.webkit.messageHandlers.closeBrowsers.postMessage('');
        }
      } catch (error) {
        console.log(error)
      }
    }

    function handle(event) {
      event.preventDefault();
    }
  </script>
</body>

</html>