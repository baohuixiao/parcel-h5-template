<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <title>收件信息</title>
  <script src="https://act.development.platform.babybus.com/lib/jquery/dist/jquery.min.js"></script>
  <script src="https://act.development.platform.babybus.com/lib/tool/vconsole.min.js"></script>
  <script>
    // 页面适配
    (function () {
      var html = document.documentElement;
      var windowWidth = html.clientWidth > 600 ? 600 : html.clientWidth;
      html.style.fontSize = windowWidth / 7.5 + 'px';
    }());
    var vConsole = new VConsole();
  </script>

  <link rel="stylesheet" type="text/css" href="./css/expressInfo.css" />

</head>

<body>
  <!-- 埋点 -->
  <!-- <div style="position: absolute;width:0;height:0;overflow:hidden;">
    <script type="text/javascript" src="https://s9.cnzz.com/z_stat.php?id=1279349239&web_id=1279349239"></script>
  </div> -->
  <div @touchmove.prevent class="shadow" onClick="closeSuccessPop()">
    <div class="pop-wrap">
      <img class="pop"
        src="https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210203/ce7347869dcf41e8bfad3c20c1fe8203.png" />
      <div class="pop-btn" onClick="closeSuccessPop(this)"></div>
    </div>
  </div>
  <div class="container" style="visibility: hidden;">
    <img class="address-bg" onClick="preventClick"
      src="https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210203/558b62dbbeb5423fb932b670fe555d91.png" />
    <div class="content-wrap">
      <div class="content-item">
        收货人：<input class="input" id="name" placeholder="请输入2-10个中文汉字" maxlength="10" />
      </div>
      <div class="content-item">
        详细地址：
        <textarea id="textarea" class="textarea" maxlength="40" rows="3" cols="20"
          placeholder="请输入省、市、区及剩余详细地址(6-40字)"></textarea>
      </div>
      <div class="content-item">
        联系电话：<input class="input" id="phone" placeholder="重要！请填写11位正确手机号" tabindex="1" type='text' maxlength="11"
          autocomplete="off" />
      </div>
      <div class="tip-wrap">(宝宝巴士将在您提交收件信息后7个工作日内发出礼品)</div>
    </div>
  </div>

  <img class="bottom-btn" id="submit"
    src="https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210203/e7e2cfcc657d4b3abc176d39b4635999.png" />
  <script>
    var _czc = _czc || [];
    _czc.push(["_setAccount", "1279349239"]);
    var OrderNo = getQueryString('OrderNo');
    var aid = getQueryString('aid');

    //获取页面传参
    function getQueryString(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
      var r = window.location.search.substr(1).match(reg);
      if (r != null) return decodeURI(r[2]);
      return null;
    }

    var toastFlag = true;

    // toast控件封装
    function showToast(text, duration) {
      if (!(text.trim()) || !toastFlag) {
        return;
      }
      var timer = null;
      toastFlag = false;

      var toastWrap = document.createElement('div');
      toastWrap.style.cssText =
        'position: fixed; font-size: 0.32rem; color: #fff; z-index: 5; max-width: 5rem;text-align: center;top:40%;padding: 0.1rem 0.3rem;border-radius: 0.5rem;background-color: rgba(0, 0, 0, 0.7);display: flex;left:50%;transform: translateX(-50%);';
      toastWrap.innerText = text;
      document.body.appendChild(toastWrap);
      timer = setTimeout(function () {
        toastFlag = true;
        clearTimeout(timer)
        document.body.removeChild(toastWrap);
      }, duration)
    }

    $('input').on('blur', function () {
      console.log('input blur');
      $('#submit').removeClass("hidden");
      setTimeout(function () {
        var scrollHeight = document.documentElement.scrollTop || document.body.scrollTop || 0;
        window.scrollTo(0, Math.max(scrollHeight - 1, 0));
      }, 100);
    });
    $('textarea').on('blur', function () {
      console.log('textarea blur');
      $('#submit').removeClass("hidden");
      setTimeout(function () {
        var scrollHeight = document.documentElement.scrollTop || document.body.scrollTop || 0;
        window.scrollTo(0, Math.max(scrollHeight - 1, 0));
      }, 100);
    });
    $('input').on('focus', function () {
      console.log('input focus');
      $('#submit').addClass("hidden");
    });
    $('textarea').on('focus', function () {
      console.log('textarea focus');
      $('#submit').addClass("hidden");
    });

    // 解决安卓下，键盘弹出后，绝对定位元素不往上顶问题
    var isAndroid = navigator.userAgent.toLowerCase().indexOf('android') >= 0;
    var originHeight = document.documentElement.clientHeight || document.body.clientHeight;

    function resizeHandler() {
      var resizeHeight = document.documentElement.clientHeight || document.body.clientHeight;
      var activeElement = document.activeElement;
      console.log(resizeHeight, originHeight)
      if (resizeHeight < originHeight) {
        console.log('键盘弹起后逻辑');
        // 键盘弹起后逻辑
      } else {
        console.log('键盘收起后逻辑');
        // 键盘收起后逻辑
        $('#submit').removeClass("hidden");
      }
    };
    if (isAndroid) {
      window.addEventListener('resize', resizeHandler);
    }

    //校验手机号
    function isPoneAvailable(phone) {
      var myreg = /^[1][3,4,5,6,7,8,9][0-9]{9}$/;
      if (!myreg.test(phone)) {
        return false;
      } else {
        return true;
      }
    }

    oBtn = document.getElementById('submit');

    function debounce(fn, time, triggleNow) {
      var t = null;

      return function () {
        var _self = this
        args = arguments;

        if (t) {
          clearTimeout(t);
        }

        if (triggleNow) {
          var exce = !t;

          t = setTimeout(function () {
            t = null;
          }, time)

          if (exce) {
            fn.apply(_self, args);
          }
        } else {
          t = setTimeout(function () {
            fn.apply(_self, args);
            t = null;
          }, time)
        }
      }
    }

    oBtn.onclick = debounce(sendAddressText, 300, true)

    function sendAddressText() {
      checkData();
    }

    function checkData() {
      var phone = $("#phone").val();
      var name = $("#name").val();
      var address = $("#textarea").val();
      var tip = '请输入正确的信息';
      console.log(isPoneAvailable(phone))
      if (isPoneAvailable(phone) && address.length >= 6 && name.length >= 2) {
        if (navigator.onLine) {
          postData(phone, name, address)
        } else {
          showToast('网络未连接，请检查网络设置', 2000);
        }
      } else {
        if (name.length < 2) {
          tip = '请输入正确的收货人名称';
        } else if (address.length < 6) {
          tip = '请输入正确的地址';
        } else if (!isPoneAvailable(phone)) {
          tip = '请输入正确的手机号';
        }
        showToast(tip, 2000);
      }
    }

    function postData(phoneNumber, userName, address) {
      try {
        _czc.push(["_trackEvent", "提交收件信息", "点击"])
      } catch (error) {
        console.log(error)
      }
      $.ajax({
        url: '/AppActivity/VipGift_SetExpressInfo',
        data: {
          phone: phoneNumber,
          orderNo: OrderNo,
          userName: userName,
          address: address,
          aid: aid,
        },
        method: 'POST',
        dataType: 'json',
        complete: function (res) {
          console.log(res)
        },
        success: function (res) {
          console.log("发送成功")
          if (res.ResultCode === "0") {
            try {
              _czc.push(["_trackEvent", "收件信息提交", "成功"])
            } catch (error) {
              console.log(error)
            }
            showSuccessPop();
          } else {
            try {
              _czc.push(["_trackEvent", "收件信息提交", "失败"])
            } catch (error) {
              console.log(error)
            }
            showToast(res.ResultMessage, 2000);
          }
        },
        fail: function (err) {
          try {
            _czc.push(["_trackEvent", "收件信息提交失败", ""])
          } catch (error) {
            console.log(error)
          }
          showToast('发送失败,请稍后重试', 2000);
          console.log("发送失败")
        }
      })
    }

    function showSuccessPop() {
      $("html").add("body").css({
        "overflow": "hidden"
      })
      $('html').css('height', '100%')
      $('body').css('height', '100%')
      document.body.addEventListener('touchmove', handle, {
        passive: false
      })
      //显示领取成功弹窗
      document.querySelector(".shadow").style.display = 'block';
    }

    function closeSuccessPop() {
      $("html").add("body").css({
        "overflow": "auto"
      })
      $('html').css('height', 'auto')
      $('body').css('height', 'auto')
      document.body.removeEventListener('touchmove', handle, {
        passive: false
      })
      document.querySelector(".shadow").style.display = 'none';
    }

    function handle(event) {
      event.preventDefault();
    }

    //禁止图片点击
    function preventClick(e) {
      e.stopPropagation()
      e.preventDefault()
      return false;
    }

    $(".container").css('visibility', 'visible');
  </script>
</body>

</html>