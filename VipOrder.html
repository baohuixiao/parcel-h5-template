<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <title>订单记录</title>
    <script src="https://act.development.platform.babybus.com/lib/jquery/dist/jquery.min.js"></script>
    <script src="https://act.development.platform.babybus.com/lib/tool/vconsole.min.js"></script>
    <script>
        // 服务端数据
        var canUsedNum = 10; //当前公仔数量
        var orderList = [{
                "ProductName": "tcyO4hhevW",
                "OrderName": "wrHoRvQOE7",
                "Price": 54579,
                "StartDateName": "e0FusafG7q",
                "EndDateName": "kR3qqUMISx",
                "PayDateShow": "YOMLc3IkSr",
                "PayDate": 1612336509047,
                "ChannelTypeName": "J070gMGi42",
                "OrderNo": "myYXkT84FX",
                "Address": ""
            },
            {
                "ProductName": "ZD7NBdioT9",
                "OrderName": "Vu66bkDxIL",
                "Price": 55481,
                "StartDateName": "DUuKBi8kzH",
                "EndDateName": "usc3NF2FM7",
                "PayDateShow": "97W5Or3sPq",
                "PayDate": 1612334145670,
                "ChannelTypeName": "v76gtq4fU5",
                "OrderNo": "Rq3GdyAK36",
                "Address": "53ilbqH7rL"
            },
        ]; //用户会员订单列表
        var joinBeginTime = 1612157754; //购买会员开始时间
        var joinEndTime = 1612336509048; //购买会员截止时间
        var exChangeEndTime = 1612336509049; //兑换截止时间
        var serverTime = 1612419866; //系统当前时间 毫秒

        // 页面适配
        (function () {
            var html = document.documentElement;
            var windowWidth = html.clientWidth > 600 ? 600 : html.clientWidth;
            html.style.fontSize = windowWidth / 7.5 + 'px';
        }());
        var vConsole = new VConsole();
    </script>

    <link rel="stylesheet" type="text/css" href="./css/vipOrder.css" />
</head>

<body>
    <!-- 埋点 -->
    <div style="position: absolute;width:0;height:0;overflow:hidden;">
        <script type="text/javascript" src="https://s9.cnzz.com/z_stat.php?id=1279349239&web_id=1279349239"></script>
    </div>
    <div id="container" class="container" style="visibility: hidden;">
        <div class="content" v-if="orderList.length > 0">
            <div class="order-item" v-for="(orderItem, index) in orderList" :key="orderItem.OrderNo">
                <div class="order-item-top">
                    <span>{{orderItem.ProductName}} - {{orderItem.OrderName}}</span>
                    <span>¥{{orderItem.Price}}</span>
                </div>
                <div class="order-item-contnet">
                    <div class="item-row" v-if="orderItem.StartDateName">
                        <span class="item-row-title">会员生效时间：</span>
                        <span class="item-row-result">{{orderItem.StartDateName}}</span>
                    </div>
                    <div class="item-row" v-if="orderItem.EndDateName">
                        <span class="item-row-title">会员到期时间：</span>
                        <span class="item-row-result">{{orderItem.EndDateName}}</span>
                    </div>
                    <div class="item-row" v-if="orderItem.PayDateShow">
                        <span class="item-row-title">购买时间：</span>
                        <span class="item-row-result">{{orderItem.PayDateShow}}</span>
                    </div>
                    <div class="item-row" v-if="orderItem.ChannelTypeName">
                        <span class="item-row-title">购买方式：</span>
                        <span class="item-row-result">{{orderItem.ChannelTypeName}}</span>
                    </div>
                    <div class="item-row" v-if="orderItem.OrderNo">
                        <span class="item-row-title">订单编号：</span>
                        <span class="item-row-result">{{orderItem.OrderNo}}</span>
                    </div>
                    <div class="item-row" v-if="orderItem.Address.length > 0">
                        <span class="item-row-title">收件信息：</span>
                        <span class="item-row-result">{{orderItem.Address}}</span>
                    </div>
                    <div class="item-row"
                        v-if="(orderItem.PayDate > joinEndTime || serverTime > exChangeEndTime) && orderItem.Address.length === 0">
                        <span class="item-tip-text">活动已结束</span>
                    </div>
                    <div class="item-row"
                        v-if="(orderItem.PayDate < joinEndTime || serverTime < exChangeEndTime) && orderItem.Address.length === 0 && canUsedNum <= 0">
                        <span class="item-tip-text">礼品已被领完了，下次早点来哦~</span>
                    </div>
                </div>
                <div @click="clickOrderItem(orderItem.OrderNo)" class="order-item-btn"
                    v-if="canUsedNum > 0 && orderItem.Address.length <= 0 && orderItem.PayDate <= joinEndTime && serverTime <= exChangeEndTime">
                    填写收件信息</div>
                <div class="divider" v-if="index < orderList.length - 1"></div>
            </div>
            <div class="tip-wrap">
                温馨提示：</br>1、宝宝巴士将在收到您收件信息后的7个工作日内为您发出礼品;</br></br>
                2、如收件信息有变更或其他疑问，可联系QQ客服。VIP会员客服热线1：18059175351；热线2：18050313972
            </div>
            <div class="refresh-btn-wrap" @click="clickReLoad">
                <img
                    src="https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210222/52353862328c48bc8f42b56c4db560f6.png" />
            </div>
        </div>
        <div id="empty" class="empty" v-else>
            <div class="empty-item">
                <img class="empty-img"
                    src="https://picfile-baidu.babybus.com/ActivityData/BabyBusFile/20210204/09c7ed1abe5343f3b00904ee6b17a019.png" />
                <span class="empty-title">目前还没有订单哦~</span>
            </div>
        </div>
    </div>
</body>

<!-- 服务端vue -->
<!-- <script src="https://actcdn.babybus.com/lib/vue/vue.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>
    var _czc = _czc || [];
    _czc.push(["_setAccount", "1279349239"]);

    var app = new Vue({
        el: '.container',

        data: {
            orderList: [],
            aid: '',
            joinBeginTime,
            joinEndTime,
            exChangeEndTime,
            serverTime,
            canUsedNum
        },

        methods: {

            clickReLoad: debounce(function () {
                this.getOrderList();
            }, 500, true),

            clickOrderItem: debounce(function (orderNo) {
                if (orderNo) {
                    try {
                        _czc.push(["_trackEvent", "填写收件信息领公仔", "点击"])
                    } catch (error) {
                        console.log(error)
                    }
                    var url = window.location.origin +
                        '/appactivity/ModulePageApp?pageid=fd30e35935844415b668778084f7c49f&aid=' +
                        this.aid + '&OrderNo=' +
                        orderNo;
                    window.location.href = '?Client=Target&Type=Inner&Url=' + encodeURIComponent(url) +
                        '&Title=收件信息&IsHeader=1&IsNewWindow=1';
                }
            }, 500, true),

            getOrderList: function () {
                var that = this;
                $.ajax({
                    url: '/AppActivity/VipGift_OrderData',
                    data: {
                        aid: this.aid,
                    },
                    method: 'GET',
                    dataType: 'json',
                    success: function (res) {
                        console.log(res);
                        if (res.ResultCode === "0") {
                            that.orderList = res.Data.OrderList; //用户会员订单列表
                            try {
                                that.serverTime = res.Data.ActivityExtData.ServerTime;
                                that.canUsedNum = res.Data.ActivityExtData.CanUsedNum;
                            } catch (err) {
                                console.log(err);
                            }
                            $(".container").css('visibility', 'visible');
                        } else {
                            $(".container").css('visibility', 'visible');
                        }
                    },
                    fail: function (err) {
                        console.log("发送失败");
                        $(".container").css('visibility', 'visible');
                    }
                })
            },

            //获取页面传参
            getQueryString: function (name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) return decodeURI(r[2]);
                return null;
            },

            addPageShowListener: function () {
                var that = this;
                var hiddenProperty = 'hidden' in document ? 'hidden' :
                    'webkitHidden' in document ? 'webkitHidden' :
                    'mozHidden' in document ? 'mozHidden' :
                    null;
                var visibilityChangeEvent = hiddenProperty.replace(/hidden/i, 'visibilitychange');
                var onVisibilityChange = function () {
                    if (!document[hiddenProperty]) {
                        console.log('我出现了');
                        var result = localStorage.getItem('toFresh');
                        localStorage.removeItem('toFresh');
                        if (result !== null && result === 'true') {
                            that.clickReLoad();
                        }
                    } else {
                        console.log('我隐藏了');
                        localStorage.removeItem('toFresh');
                    }
                }
                document.addEventListener(visibilityChangeEvent, onVisibilityChange)
            },
        },

        mounted: function () {
            this.aid = this.getQueryString('aid');
            this.getOrderList();
            this.addPageShowListener();
        }
    })

    // 防抖函数
    function debounce(fn, time, triggleNow) {
        var t = null;

        return function () {
            var _self = this
            args = arguments;

            if (t) {
                clearTimeout(t);
            }

            if (triggleNow) {
                var exce = !t;

                t = setTimeout(function () {
                    t = null;
                }, time)

                if (exce) {
                    fn.apply(_self, args);
                }
            } else {
                t = setTimeout(function () {
                    fn.apply(_self, args);
                    t = null;
                }, time)
            }
        }
    }
</script>

</html>