@using Baby.AudioData.Entity;
@using Newtonsoft.Json.Linq;
@using Leo.ActivityData.Entity;

@model Dictionary<string, object>
@{
    Layout = null;

    //通用的错误提示信息
    var errorMsg = !Model.ContainsKey("ErrorMsg") ? "" : Model["ErrorMsg"].ToString();
    var errorCode = !Model.ContainsKey("ErrorCode") ? "" : Model["ErrorCode"].ToString();

    //接口域名前缀
    var hostName = !Model.ContainsKey("ResHostName") ? "" : Model["ResHostName"].ToString();

    //资源域名前缀,正式线上使用CDN域名，否则使用接口域名
    var resHostName = hostName.Replace("https://act.babybus.com", "https://actcdn.babybus.com");

    //活动数据
    var activityInfo = !Model.ContainsKey("ActivityInfo") ? new VipGiftActivity() : (VipGiftActivity)Model["ActivityInfo"];

    //活动状态   1未开始 2进行中 3活动已结束但可以兑换 4活动已结束也不能兑换
    var activityState = 1;
    if (activityInfo.ActivityID > 0 && activityInfo.VipBeginTime >= DateTime.Now)
        activityState = 1;
    else if (activityInfo.ActivityID > 0 && DateTime.Now >= activityInfo.VipBeginTime && activityInfo.VipEndTime >= DateTime.Now)
        activityState = 2;
    else if (activityInfo.ActivityID > 0 && DateTime.Now >= activityInfo.VipBeginTime && DateTime.Now > activityInfo.VipEndTime && activityInfo.GiftEndTime > DateTime.Now)
        activityState = 3;
    else activityState = 4;

    var currGiftNum = activityInfo.GiftAllNum - activityInfo.GiftCurrNum;

   

}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <title>收件信息</title>
    <script src="@resHostName/lib/jquery/dist/jquery.min.js"></script>
    <script src="@resHostName/vipgift/js/tools.js"></script>
    <!-- <script src="@resHostName/vipgift/js/vconsole.min.js"></script> -->
    <script>

        var errorCode = '@Html.Raw(errorCode)';     //错误号
        var errorMsg = '@Html.Raw(errorMsg)';      //错误提示信息
        var activityState =@activityState;       //活动状态  1未开始 2进行中 3活动已结束但可以兑换 4活动已结束也不能兑换
        var giftNum =@currGiftNum;              //当前公仔数量

        initTools.setRootFontSize();
        //var vConsole = new VConsole();
    </script>

    <link rel="stylesheet" type="text/css" href="@resHostName/vipgift/css/common.css" />
    <style>
        .container {
            position: relative;
            width: 100vw;
        }

        .address-bg {
            width: 100vw !important;
            height: 13.34rem !important;
        }

        .content-wrap {
            position: absolute;
            top: 7.71rem;
            left: 0;
            width: 100vw;
            font-size: 0.28rem;
            color: #484848;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container>img {
            width: 100%;
        }

        .bottom-btn {
            position: fixed;
                left: 50%;
    bottom: 0.22rem;
    width: 6.96rem;
    height: 0.96rem;
    margin-left: -3.48rem;
        }

        .input {
            outline: none;
            width: 4rem;
            height: 0.606rem;
            border-radius: 0.21rem;
            border: 0.02rem solid #484848;
            padding: 0.183rem 0 0.183rem 0.2rem;
            box-sizing: border-box;
            font-size: 0.24rem;
        }

        .textarea {
            outline: none;
            width: 4rem;
            border-radius: 0.21rem;
            border: 0.02rem solid #484848;
            padding: 0.183rem 0.2rem;
            box-sizing: border-box;
            font-size: 0.24rem;
        }

        .content-item {
            margin-top: 0.27rem;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-width: 5.4rem;
        }

        .tip-wrap {
            margin-top: 0.27rem;
            width: 100%;
            text-align: center;
            font-size: 0.24rem !important;
                color: #FC2A52;
    opacity: 0.47;
            font-weight: 500;
        }

      .mask {
        position: fixed;
        z-index: 5;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
      }

      .toast {
        position: fixed;
        top: 40%;
        z-index: 5;
        max-width: 5rem;
        text-align: center;
        padding: 0.1rem 0.3rem;
        border-radius: 0.5rem;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        left: 50%;
        transform: translateX(-50%);
      }

      .toast text {
        font-size: .32rem;
        color: #fff;
      }

        input::-webkit-input-placeholder {
          color: rgba(72, 72, 72, 0.47);
          font-size: 0.24rem;
        }

        textarea::-webkit-input-placeholder {
          color: rgba(72, 72, 72, 0.47);
          font-size: 0.24rem;
        }

                .shadow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            background: rgba(0, 0, 0, .66);
            display: none;
        }

        .pop-wrap {
                width: 6.57rem;
    height: 6.99rem;
            position: absolute;
            left: 0;
            right: 0;
            margin: 0 auto;
            top: 2.6rem;
        }

        .pop {
    width: 6.57rem;
    height: 6.99rem;
        }

        .pop-btn {
    width: 6.57rem;
    height: 1rem;
            position: absolute;
    bottom: 0rem;
    left: 0rem;
        }
        @@media (min-width: 700px) {
            .pop-wrap {
      width: 657px;
      height: 699px;
                top: 50%;
                left: 50%;
      margin-left: -328px;
      margin-top: -350px;
            }

            .pop {
      width: 657px;
      height: 699px;
            }

            .pop-btn {
      width: 657px;
      height: 100px;
                position: absolute;
      bottom: 0px;
      left: 0px;
            }
        }
    </style>

</head>

<body style="visibility: hidden;">
    <!-- 埋点 -->
    @* <div style="position: absolute;width:0;height:0;overflow:hidden;">
        <script type="text/javascript" src="https://s9.cnzz.com/z_stat.php?id=1279350092&web_id=1279350092"></script>
    </div> *@
    <div style="position: absolute;width:0;height:0;overflow:hidden;">
        <script type="text/javascript" src="https://s9.cnzz.com/z_stat.php?id=1279349239&web_id=1279349239"></script>
    </div>
    <div @@touchmove.prevent class="shadow" onClick="closeSuccessPop()">
    <div class="pop-wrap">
              <img class="pop" src="@resHostName/vipgift/img/pop-bg-new.png" onClick="stopBubble()" />
      <div class="pop-btn" onClick="closeSuccessPop(this)"></div>
    </div>
    </div>
    <div id="mask" class="mask hidden">
      <div id="toast" class="toast">
        <text id="toast-content">请输入正确的信息</text>
      </div>
    </div>
    <div class="container">
    <!-- <img class="address-bg" onClick="preventClick" src="@resHostName/vipgift/img/address-bg.png" /> -->
    <!-- <img class="address-bg" onClick="preventClick" src="@resHostName/vipgift/img/address-bg-fullyear.png" /> -->
    <img class="address-bg" onClick="preventClick" src="@resHostName/vipgift/img/address-bg-new1.png" />
    <div class="content-wrap">
      <div class="content-item">
        收货人：<input class="input" id="name" placeholder="请输入2-10个中文汉字" maxlength="10" />
      </div>
      <div class="content-item">
        详细地址：
        <textarea id="textarea" class="textarea" maxlength="40" rows="3" cols="20"
          placeholder="请输入省、市、区及剩余详细地址(6-40字)"></textarea>
      </div>
      <div class="content-item">
        手机号：<input class="input" id="phone" placeholder="重要！请填写11位正确手机号" tabindex="1" type='text' maxlength="11"
         autocomplete="off" />
      </div>
      <div class="tip-wrap">(宝宝巴士将在您提交收件信息后7个工作日内发出手办)</div>
    </div>
  </div>

  <img class="bottom-btn" id="submit" src="@resHostName/vipgift/img/sendInfo.png" />
  <script>
    var _czc = _czc || [];
    _czc.push(["_setAccount", "1279349239"]);
    var OrderNo = getQueryString('OrderNo');
    var aid = getQueryString('aid');

      //获取页面传参
    function getQueryString(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
      var r = window.location.search.substr(1).match(reg);
      if (r != null) return decodeURI(r[2]);
      return null;
    }

    $('input').on('blur', function () {
      console.log('input blur');
      $('#submit').removeClass("hidden");
      setTimeout(function () {
        var scrollHeight = document.documentElement.scrollTop || document.body.scrollTop || 0;
        window.scrollTo(0, Math.max(scrollHeight - 1, 0));
      }, 100);
    });
    $('textarea').on('blur', function () {
      console.log('textarea blur');
      $('#submit').removeClass("hidden");
      setTimeout(function () {
        var scrollHeight = document.documentElement.scrollTop || document.body.scrollTop || 0;
        window.scrollTo(0, Math.max(scrollHeight - 1, 0));
      }, 100);
    });
    $('input').on('focus', function () {
      console.log('input focus');
      $('#submit').addClass("hidden");
    });
    $('textarea').on('focus', function () {
      console.log('textarea focus');
      $('#submit').addClass("hidden");
    });

    // 解决安卓下，键盘弹出后，绝对定位元素不往上顶问题
    var isAndroid = navigator.userAgent.toLowerCase().indexOf('android') >= 0;
    var originHeight = document.documentElement.clientHeight || document.body.clientHeight;

    function resizeHandler() {
      var resizeHeight = document.documentElement.clientHeight || document.body.clientHeight;
      var activeElement = document.activeElement;
      console.log(resizeHeight, originHeight)
      if (resizeHeight < originHeight) {
        console.log('键盘弹起后逻辑');
        // 键盘弹起后逻辑
      } else {
        console.log('键盘收起后逻辑');
        // 键盘收起后逻辑
        $('#submit').removeClass("hidden");
      }
    };
    if (isAndroid) {
      window.addEventListener('resize', resizeHandler);
    }

    //校验手机号
    function isPoneAvailable(phone) {
      var myreg = /^[1][3,4,5,6,7,8,9][0-9]{9}$/;
      if (!myreg.test(phone)) {
        return false;
      } else {
        return true;
      }
    }

    oBtn = document.getElementById('submit');

    oBtn.onclick = initTools.debounce(sendAddressText, 300, true)

    function sendAddressText() {
      checkData();
    }

    function checkData() {
      var phone = $("#phone").val();
      var name = $("#name").val();
      var address = $("#textarea").val();
      var tip = '请输入正确的信息';
      console.log(isPoneAvailable(phone))
      if (isPoneAvailable(phone) && address.length >= 6 && name.length >= 2) {
        if (navigator.onLine) {
          postData(phone, name, address)
        } else {
          $('#mask').removeClass("hidden");
          $('#toast-content').text('网络未连接，请检查网络设置');
          setTimeout(function () {
            $('#toast-content').text('不在活动时间哦');
            $('#mask').addClass("hidden");
          }, 2000)
        }
      } else {
        if (name.length < 2) {
          tip = '请输入正确的收货人名称';
        } else if (address.length < 6) {
          tip = '请输入正确的地址';
        } else if (!isPoneAvailable(phone)) {
          tip = '请输入正确的手机号';
        }
        $('#mask').removeClass("hidden");
        $('#toast-content').text(tip);
        setTimeout(function () {
          $('#toast-content').text('不在活动时间哦');
          $('#mask').addClass("hidden");
        }, 2000)
      }
    }

    function postData(phoneNumber, userName, address) {
      try {
        _czc.push(["_trackEvent", "提交收件信息", "点击"])
      } catch (error) {
        console.log(error)
      }
      $.ajax({
        url: 'SetExpressInfo',
        data: {
          phone: phoneNumber,
          orderNo: OrderNo,
          userName: userName,
          address: address,
          aid: aid,
        },
        method: 'POST',
        dataType: 'json',
        complete: function (res) {
          console.log(res)
        },
        success: function (res) {
          console.log("发送成功")
          if (res.resultCode === "0") {
            try {
              _czc.push(["_trackEvent", "收件信息提交", "成功"])
            } catch (error) {
              console.log(error)
            }
            localStorage.setItem("refresh", true);
            console.log(localStorage.getItem("refresh"));
            showSuccessPop();
            @* window.history.back(); *@
          } else {
            try {
              _czc.push(["_trackEvent", "收件信息提交", "失败"])
            } catch (error) {
              console.log(error)
            }
            $('#mask').removeClass("hidden");
            $('#toast-content').text(res.resultMessage);
            setTimeout(function () {
              $('#toast-content').text('');
              $('#mask').addClass("hidden");
            }, 2000)
          }
        },
        fail: function (err) {
          try {
            _czc.push(["_trackEvent", "收件信息提交失败", ""])
          } catch (error) {
            console.log(error)
          }
          $('#mask').removeClass("hidden");
          $('#toast-content').text("发送失败,请稍后重试");
          setTimeout(function () {
            $('#toast-content').text('不在活动时间哦');
            $('#mask').addClass("hidden");
          }, 2000)
          console.log("发送失败")
        }
      })
    }

            function showSuccessPop() {
            $("html").add("body").css({
                "overflow": "hidden"
            })
            $('html').css('height', '100%')
            $('body').css('height', '100%')
            document.body.addEventListener('touchmove', handle, {
                passive: false
            })
            //显示领取成功弹窗
            document.querySelector(".shadow").style.display = 'block';
        }

                function closeSuccessPop() {
            $("html").add("body").css({
                "overflow": "auto"
            })
            $('html').css('height', 'auto')
            $('body').css('height', 'auto')
            document.body.removeEventListener('touchmove', handle, {
                passive: false
            })
            document.querySelector(".shadow").style.display = 'none';
        }

                function handle(event) {
            event.preventDefault();
        }

    //禁止图片点击
    function preventClick(e) {
      e.stopPropagation()
      e.preventDefault()
      return false;
    }
  </script>
</body>

<script>
  $("body").css('visibility', 'visible');
</script>



</html>
